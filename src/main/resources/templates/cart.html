<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng - T√°o Phone</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Segoe UI", sans-serif;
        }

        h2 {
            text-align: center;
            margin: 30px 0;
            font-weight: 600;
            color: #333;
        }

        table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 12px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background-color: #f1f1f1;
            font-weight: 600;
        }

        tr:hover td {
            background-color: #fafafa;
        }

        .total {
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 20px;
        }

        button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #b52a36;
        }

        .btn-quantity {
            background-color: #007bff;
            padding: 3px 8px;
            font-size: 0.9rem;
            margin: 0 3px;
        }

        .btn-quantity:hover {
            background-color: #0056b3;
        }

        .quantity-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .empty-cart {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-cart img {
            width: 200px;
            opacity: 0.8;
        }

        .empty-cart h4 {
            margin-top: 20px;
            color: #555;
        }

        .btn-home {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 25px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: 0.3s;
        }

        .btn-home:hover {
            background-color: #0056b3;
            text-decoration: none;
            color: #fff;
        }
    </style>
</head>
<body>

<!-- Header -->
<div th:replace="fragments/header :: siteHeader"></div>

<div class="container mt-4 mb-5">

    <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <!-- N·∫øu gi·ªè h√†ng c√≥ s·∫£n ph·∫©m -->
    <div th:if="${#lists.size(cartItems) > 0}">
        <table class="table">
            <thead>
            <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>M√†u</th>
                <th>B·∫£n m√°y</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>T·ªïng</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cartItems}">
                <td th:text="${item.tenHangHoa}">T√™n s·∫£n ph·∫©m</td>
                <td th:text="${item.mauSac}">M√†u</td>
                <td th:text="${item.tenMay}">B·∫£n m√°y</td>
                <td>
                    <div class="quantity-group">
                        <button class="btn-quantity" onclick="updateQuantity(this, -1)">‚àí</button>
                        <span class="qty-value" th:text="${item.soluong}">1</span>
                        <button class="btn-quantity" onclick="updateQuantity(this, 1)">+</button>
                    </div>
                </td>
                <td th:text="${#numbers.formatDecimal(item.dongia, 0, 0)} + '‚Ç´'">0‚Ç´</td>
                <td class="total-cell" th:text="${#numbers.formatDecimal(item.dongia * item.soluong, 0, 0)} + '‚Ç´'">0‚Ç´</td>
                <td>
                    <button class="btn-delete" onclick="deleteItem(this)">üóëÔ∏è X√≥a</button>
                    <input type="hidden" name="idhanghoa" class="idhanghoa" th:value="${item.idhanghoa}" />
                    <input type="hidden" name="idmau" class="idmau" th:value="${item.idmau}" />
                    <input type="hidden" name="idmay" class="idmay" th:value="${item.idmay}" />
                    <input type="hidden" name="idbonho" class="idbonho" th:value="${item.idbonho}" />
                    <input type="hidden" name="dongia" class="dongia" th:value="${item.dongia}" />
                </td>
            </tr>
            </tbody>
        </table>

        <p class="total">
            T·ªïng ti·ªÅn: <span th:text="${#numbers.formatDecimal(totalPrice, 0, 0)} + '‚Ç´'">0‚Ç´</span>
        </p>
    </div>

    <!-- N·∫øu gi·ªè h√†ng tr·ªëng -->
    <div th:if="${#lists.isEmpty(cartItems)}" class="empty-cart">
        <img src="/images/Cart/emptycart.png" alt="Empty Cart">
        <h4>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h4>
        <p>H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè ƒë·ªÉ b·∫Øt ƒë·∫ßu mua s·∫Øm!</p>
        <a th:href="@{/}" class="btn-home">üõí V·ªÅ trang ch·ªß</a>
    </div>
</div>

<!-- Footer -->
<div th:replace="fragments/footer :: siteFooter"></div>

<script>
    function updateQuantity(btn, change) {
        const row = btn.closest('tr');
        const qtySpan = row.querySelector('.qty-value');
        const totalCell = row.querySelector('.total-cell');
        const currentQty = parseInt(qtySpan.textContent);
        const newQty = Math.max(1, currentQty + change);

        if (newQty === currentQty) return; // Kh√¥ng thay ƒë·ªïi

        // C·∫≠p nh·∫≠t UI
        qtySpan.textContent = newQty;
        const priceInput = row.querySelector('input[name="dongia"]');
        const price = parseFloat(priceInput ? priceInput.value : 0);
        const newTotal = (price * newQty).toLocaleString('vi-VN');
        totalCell.textContent = newTotal + '‚Ç´';

        // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t backend
        const idhanghoa = parseInt(row.querySelector('input[name="idhanghoa"]').value);
        const idmau = parseInt(row.querySelector('input[name="idmau"]').value);
        const idmay = parseInt(row.querySelector('input[name="idmay"]').value);
        const idbonho = parseInt(row.querySelector('input[name="idbonho"]').value);

        console.log('üìù Updating quantity:', { idhanghoa, idmau, idmay, idbonho, quantity: newQty });

        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idhanghoa, idmau, idmay, idbonho, quantity: newQty })
        })
        .then(res => res.json())
        .then(data => {
            console.log('Response:', data);
            if (data && data.status === 'ok') {
                console.log('‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh c√¥ng');
                updateTotalPrice();
            } else {
                console.error('‚ùå L·ªói c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:', data);
                alert('‚ùå L·ªói: ' + (data?.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
                location.reload();
            }
        })
        .catch(err => {
            console.error('Fetch Error:', err);
            alert('L·ªói m·∫°ng!');
        });
    }

    function deleteItem(btn) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

        const row = btn.closest('tr');
        const idhanghoa = parseInt(row.querySelector('input[name="idhanghoa"]').value);
        const idmau = parseInt(row.querySelector('input[name="idmau"]').value);
        const idmay = parseInt(row.querySelector('input[name="idmay"]').value);
        const idbonho = parseInt(row.querySelector('input[name="idbonho"]').value);

        console.log('üóëÔ∏è Deleting item:', { idhanghoa, idmau, idmay, idbonho });

        fetch('/cart/removeJson', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idhanghoa, idmau, idmay, idbonho })
        })
        .then(res => res.json())
        .then(data => {
            console.log('Response:', data);
            if (data && data.status === 'ok') {
                console.log('‚úÖ X√≥a s·∫£n ph·∫©m th√†nh c√¥ng');
                row.remove();
                updateTotalPrice();
                // C·∫≠p nh·∫≠t cartCount trong header
                const badge = document.querySelector('.badge-danger');
                if (badge) badge.textContent = data.cartCount || 0;
                // Ki·ªÉm tra n·∫øu gi·ªè tr·ªëng, reload
                if (document.querySelectorAll('tbody tr').length === 0) {
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                console.error('‚ùå L·ªói x√≥a s·∫£n ph·∫©m:', data);
                alert('‚ùå L·ªói: ' + (data?.message || 'Kh√¥ng th·ªÉ x√≥a'));
            }
        })
        .catch(err => {
            console.error('Fetch Error:', err);
            alert('L·ªói m·∫°ng!');
        });
    }

    function updateTotalPrice() {
        const rows = document.querySelectorAll('tbody tr');
        let total = 0;
        rows.forEach(row => {
            const totalText = row.querySelector('.total-cell').textContent;
            // X√≥a ‚Ç´ v√† d·∫•u ch·∫•m ph√¢n c√°ch (.) ƒë·ªÉ l·∫•y s·ªë nguy√™n
            const price = parseFloat(totalText.replace(/‚Ç´/g, '').replace(/\./g, ''));
            total += isNaN(price) ? 0 : price;
        });
        const totalSpan = document.querySelector('.total span');
        if (totalSpan) {
            totalSpan.textContent = total.toLocaleString('vi-VN') + '‚Ç´';
        }
    }
</script>

</body>
</html>
